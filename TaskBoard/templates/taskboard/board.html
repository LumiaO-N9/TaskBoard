{% extends 'base.html' %}
{% from 'bootstrap/form.html' import render_form %}
{% block title %}TaskBoard{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default/style.min.css') }}" type="text/css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layui.css') }}" type="text/css">
    <style type="text/css">
        .panel {
            margin-top: -20px;
        }

        #project_panel {
            width: 20%;
            float: left;
        {#background: #fcf8e3;#}
        }

        #milestone_panel, #task_panel {
            width: 40%;
            float: left;
        }

        #tree-panel-body, #milestone-panel-body, #task-panel-body {
            border: none;
            box-shadow: none;
            padding: 0px;
        }

        .project_title, .task_title {
            height: 60px;
            line-height: 60px;
            text-align: center;
        }

        .layui-collapse, .task_column_panel {
            overflow: scroll;
            overflow-x: hidden;
        }

        .project_title .line, .task_title .line {
            display: inline-block;
            border-top: 1px solid #ccc;
        }

        .project_title .title, .task_title .title {
            font-size: 30px;
            font-weight: bold;
            color: #686868;
            vertical-align: middle;
        }


        body {
            overflow: hidden;
        }
    </style>
{% endblock %}
{% block content %}
    {% include '_navbar.html' %}
    <div class="container-fluid">
        <div class="row">
            <div id="project_panel" class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Project Tree</h3>
                </div>
                <div id="tree-panel-body" class="panel-body">
                </div>
            </div>
            <div id="milestone_panel" class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Milestone Column</h3>
                </div>
                <div id="milestone-panel-body" class="panel-body">
                </div>
            </div>
            <div id="task_panel" class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Task Column</h3>
                </div>
                <div id="task-panel-body" class="panel-body">
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script type="text/javascript" src="{{ url_for('static', filename='js/jstree.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/layui.js') }}"></script>
    <script type="text/javascript">
        $(function () {
            $('#board').addClass('active').children('a').removeAttr('href');
            $('#milestone-panel-body').load('{{ url_for("taskboard.render_milestone_column") }}',
                {'project_id': "{{ current_user.default_project_id }}"},
                function () {
                    setProjectLineWidth();
                    $('div[id^=task_card]').on('click', LoadTaskColumn);
                    layui.use('element', function () {
                        layui.element.init();
                    });
                });
            let size = {
                width: window.innerWidth || document.body.clientWidth,
                height: window.innerHeight || document.body.clientHeight
            };
            $('#tree-panel-body').css('height', size.height - 50 - 38);
            $('.panel').css('height', size.height - 50);
            $('.layui-collapse').css('height', size.height - 50 - 38 - 60);
            //$('#milestone_panel').css('width', (size.width - 400) / 2);
            //$('#task_panel').css('width', (size.width - 400) / 2);
            $('#tree-panel-body').jstree({
                'core': {
                    'data': {
                        'url': '{{ url_for("taskboard.tree_json") }}'
                    },
                    "themes": {
                        "variant": "large"
                    },
                    'check_callback': true,
                },
                'plugins': ['contextmenu']
            }).on("select_node.jstree", function (e, data) {
                let node = data.node;
                let id = node.id;
                let project_node;
                let project_id;
                let milestone_node_id = 'None';
                if ((new RegExp('task_node')).test(id)) {
                    project_node = $('#' + id).parents('li[id^=project_node]');
                    project_id = project_node[0].id.split('project_node')[1];
                    milestone_node_id = $('#' + id).parents('li[id^=milestone_node]')[0].id.split('milestone_node')[1];
                } else if ((new RegExp('milestone_node')).test(id)) {
                    project_node = $('#' + id).parents('li[id^=project_node]');
                    project_id = project_node[0].id.split('project_node')[1];
                    milestone_node_id = id.split('milestone_node')[1];
                } else if ((new RegExp('project_node')).test(id)) {
                    project_id = id.split('project_node')[1];
                } else {
                    return;
                }
                $('#milestone-panel-body').load('{{ url_for("taskboard.render_milestone_column") }}', {'project_id': project_id}, function () {
                    $('div[id^=task_card]').on('click', LoadTaskColumn);
                    $('#layui_colla_content' + milestone_node_id).addClass('layui-show');
                    $('.layui-collapse').css('height', size.height - 50 - 38 - 60);
                    setProjectLineWidth();
                    layui.use('element', function () {
                        layui.element.init();
                    });
                });
            });
            /*.on('loaded.jstree', function () {
                $('#tree-panel-body').jstree('open_all');
            });*/

            window.onresize = function () {
                setProjectLineWidth();
                setTaskLineWidth();
            }
        });

        function LoadTaskById(task_id) {
            $('#task-panel-body').load('{{ url_for("taskboard.render_task_column") }}', {'task_id': task_id}, function () {
                setTaskLineWidth();
                Register_time_tip();
                let size = {
                    width: window.innerWidth || document.body.clientWidth,
                    height: window.innerHeight || document.body.clientHeight
                };
                $('.task_column_panel').css('height', size.height - 50 - 38 - 60);
                layui.use('upload', function () {
                    let upload = layui.upload;
                    let upload_ele = $('#upload_attachment');
                    upload.render({
                        elem: upload_ele,
                        url: '/upload/',
                        auto: false,
                        size: 10000,
                        accept: 'file', //普通文件
                        //exts: 'zip|rar|7z|txt|doc|docx',
                        bindAction: '#upload_btn',
                        done: function (res) {
                            console.log(res)
                        }
                    });
                });
            });
        }

        function LoadTaskColumn() {
            let ele = this;
            let task_id = ele.id.split('task_card')[1];
            LoadTaskById(task_id);
        }

        function setProjectLineWidth() {
            let project_title = $('.project_title');
            let title = project_title.children('.title');
            let width = (parseInt(project_title.css('width')) - parseInt(title.css('width')) - 10) / 2;
            project_title.children('#line1').css('width', width);
            project_title.children('#line2').css('width', width);
        }

        function setTaskLineWidth() {
            let task_title = $('.task_title');
            let title = task_title.children('.title');
            let width = (parseInt(task_title.css('width')) - parseInt(title.css('width')) - 10) / 2;
            task_title.children('#line3').css('width', width);
            task_title.children('#line4').css('width', width);
        }

        function Register_time_tip() {
            let tip_index;
            $('[id^=comment_tip]').hover(function () {
                let ele = $(this);
                let time = moment(ele.data('timestamp')).format('LLL');
                tip_index = layer.tips(
                    time,
                    ele, {
                        tips: [1, '#2b2b2b'],
                    });
            }, function () {
                layer.close(tip_index);
            })
        }

        function edit_task_comment(the, comment_id) {
            let h4 = $('#add_comment_h4');
            let textarea_submit_btn = $('#comment_textarea_submit');
            let textarea_cancel_btn = $('#comment_textarea_cancel');
            let comment_text = $('#comment_text' + comment_id).children('span');
            let textarea = $('#comment_textarea');
            $('#store_comment_id').val(comment_id);  // 存储comment 的 id
            h4.text('Edit Comment');
            textarea_submit_btn.children('span').text(' Edit Comment');
            textarea.val(comment_text.text());
            textarea_cancel_btn.show();
        }

        function edit_comment_cancel() {
            let h4 = $('#add_comment_h4');
            let textarea_submit_btn = $('#comment_textarea_submit');
            let textarea_cancel_btn = $('#comment_textarea_cancel');
            let textarea = $('#comment_textarea');
            $('#store_comment_id').val('add');
            h4.text('Add Comment');
            textarea_submit_btn.children('span').text(' Submit Comment');
            textarea.val('');
            textarea_cancel_btn.hide();
        }

        function submit_comment(the, task_id) {
            let val = $('#store_comment_id').val();
            let action = 'add';
            let comment_id;
            if (val !== 'add') {
                action = 'edit'
                comment_id = val;
            }
            let comment_textarea = $('#comment_textarea');
            if (comment_textarea.val() === '') {
                layer.msg('Please input comment !');
                return;
            }
            $.ajax({
                url: "{{ url_for('taskboard.edit_or_add_comment') }}",
                type: 'POST',
                data: {
                    'action': action,
                    'task_id': task_id,
                    'comment_id': comment_id,
                    'text': comment_textarea.val()
                },
                success: function (e) {
                    if (e === 'edit') {
                        layer.msg('Comment 修改成功！');
                    } else if (e === 'add') {
                        layer.msg('Comment 增加成功！');
                    } else {
                        layer.msg('Submit failed！');
                        return;
                    }
                    setTimeout(() => {
                        LoadTaskById(task_id);
                    }, 300);
                },
                error: function (error) {
                    layer.msg('Something wrong in server！');
                    console.log(error);
                },
            });

        }

        function delete_task_comment(the, comment_id, task_id) {
            layer.open({
                type: 1,
                skin: "layui-layer-rim",
                area: ['400px', '200px'],
                title: '删除评论',
                content: '<div class="text-center" style="margin-top:20px"><p>是否确定删除此条评论 ?</p></div>',
                btn: ['删除', '取消'],
                anim: 6,
                offset: '150px',
                yes: function (index) {
                    $.ajax({
                        url: "{{ url_for('taskboard.delete_comment_by_id') }}",
                        type: 'POST',
                        data: {
                            'comment_id': comment_id,
                        },
                        success: function (e) {
                            if (e === 'ok') {
                                layer.close(index);
                                layer.msg('删除成功！');
                                setTimeout(() => {
                                    LoadTaskById(task_id);
                                }, 300);
                            } else {
                                layer.msg('删除失败！')
                            }
                        },
                    });
                },
                btn2: function (index) {
                    layer.close(index);
                }
            });

        }
    </script>
{% endblock %}
